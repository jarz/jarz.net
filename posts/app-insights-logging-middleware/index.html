<!doctype html><html lang=en><head><title>Azure Application Insights payload logging in ASP.NET Core 3.1 · Tim Jarzombek
</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=color-scheme content="light dark"><meta name=author content="Tim Jarzombek"><meta name=description content="Changes in the ASP.NET Core pipeline mean middleware is needed"><meta name=keywords content="blog,developer,personal"><meta name=twitter:card content="summary"><meta name=twitter:title content="Azure Application Insights payload logging in ASP.NET Core 3.1"><meta name=twitter:description content="Changes in the ASP.NET Core pipeline mean middleware is needed"><meta property="og:url" content="https://jarz.net/posts/app-insights-logging-middleware/"><meta property="og:site_name" content="Tim Jarzombek"><meta property="og:title" content="Azure Application Insights payload logging in ASP.NET Core 3.1"><meta property="og:description" content="Changes in the ASP.NET Core pipeline mean middleware is needed"><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2020-01-21T20:54:18-05:00"><meta property="article:modified_time" content="2020-01-21T20:54:18-05:00"><meta property="article:tag" content="Application Insights"><meta property="article:tag" content="ASP.NET Core"><link rel=canonical href=https://jarz.net/posts/app-insights-logging-middleware/><link rel=preload href=https://jarz.net/fonts/fa-brands-400.woff2 as=font type=font/woff2 crossorigin><link rel=preload href=https://jarz.net/fonts/fa-regular-400.woff2 as=font type=font/woff2 crossorigin><link rel=preload href=https://jarz.net/fonts/fa-solid-900.woff2 as=font type=font/woff2 crossorigin><link rel=stylesheet href=https://jarz.net/css/coder.min.ed30115a76cdaa62f2229e973d5b1c89b2d3dd4b1d9c07a729baad06aa3b0cbe.css integrity="sha256-7TARWnbNqmLyIp6XPVscibLT3UsdnAenKbqtBqo7DL4=" crossorigin=anonymous media=screen><link rel=icon type=image/svg+xml href=https://jarz.net/images/favicon.svg sizes=any><link rel=icon type=image/png href=https://jarz.net/favicons/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=https://jarz.net/favicons/favicon-16x16.png sizes=16x16><link rel=apple-touch-icon href=https://jarz.net/images/apple-touch-icon.png><link rel=apple-touch-icon sizes=180x180 href=https://jarz.net/images/apple-touch-icon.png><link rel=manifest href=https://jarz.net/site.webmanifest><link rel=mask-icon href=https://jarz.net/images/safari-pinned-tab.svg color=#5bbad5></head><body class="preload-transitions colorscheme-light"><div class=float-container><a id=dark-mode-toggle class=colorscheme-toggle><i class="fa-solid fa-adjust fa-fw" aria-hidden=true></i></a></div><main class=wrapper><nav class=navigation><section class=container><a class=navigation-title href=https://jarz.net/>Tim Jarzombek
</a><input type=checkbox id=menu-toggle>
<label class="menu-button float-right" for=menu-toggle><i class="fa-solid fa-bars fa-fw" aria-hidden=true></i></label><ul class=navigation-list><li class=navigation-item><a class=navigation-link href=https://jarz.net/about/>About</a></li><li class=navigation-item><a class=navigation-link href=https://jarz.net/speaking/>Speaking</a></li><li class=navigation-item><a class=navigation-link href=https://jarz.net/posts/>Blog</a></li></ul></section></nav><div class=content><section class="container post"><article><header><div class=post-title><h1 class=title><a class=title-link href=https://jarz.net/posts/app-insights-logging-middleware/>Azure Application Insights payload logging in ASP.NET Core 3.1</a></h1></div><div class=post-meta><div class=date><span class=posted-on><i class="fa-solid fa-calendar" aria-hidden=true></i>
<time datetime=2020-01-21T20:54:18-05:00>January 21, 2020
</time></span><span class=reading-time><i class="fa-solid fa-clock" aria-hidden=true></i>
5-minute read</span></div><div class=tags><i class="fa-solid fa-tag" aria-hidden=true></i>
<span class=tag><a href=https://jarz.net/tags/application-insights/>Application Insights</a>
</span><span class=separator>•</span>
<span class=tag><a href=https://jarz.net/tags/asp.net-core/>ASP.NET Core</a></span></div></div></header><div class=post-content><p>At the beginning of January I presented on <a href=https://docs.microsoft.com/en-us/azure/azure-monitor/app/app-insights-overview class=external-link target=_blank rel=noopener>Azure Application Insights</a> at CodeMash. While building my <a href=https://github.com/jarz/AlbumViewerVNext/tree/test/add-ai class=external-link target=_blank rel=noopener>demo</a> against an ASP.NET Core 3.1 project, I couldn&rsquo;t reuse an existing <em>TelemetryInitializer</em> to log request bodies for troubleshooting. A <em>TelemetryInitializer</em> allows developers to add or modify properties on telemetry sent to Application Insights; <a href=https://docs.microsoft.com/en-us/azure/azure-monitor/app/api-filtering-sampling#addmodify-properties-itelemetryinitializer class=external-link target=_blank rel=noopener>Microsoft&rsquo;s example</a> overrides the default success logic such that 400-level errors aren&rsquo;t considered failures (the default in Application Insights). Changes made in ASP.NET Core 3.0 no longer allowed me to use this:</p><div class=highlight><div style=color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">37
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cs data-lang=cs><span style=display:flex><span><span style=color:#fff;font-weight:700>public</span> <span style=color:#fff;font-weight:700>class</span> RequestBodyInitializer : ITelemetryInitializer
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#fff;font-weight:700>readonly</span> IHttpContextAccessor httpContextAccessor;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#fff;font-weight:700>public</span> RequestBodyInitializer(IHttpContextAccessor httpContextAccessor)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#fff;font-weight:700>this</span>.httpContextAccessor = httpContextAccessor;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#fff;font-weight:700>public</span> <span style=color:#fff;font-weight:700>void</span> Initialize(ITelemetry telemetry)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#fff;font-weight:700>if</span> (telemetry <span style=color:#fff;font-weight:700>is</span> RequestTelemetry requestTelemetry)
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            <span style=color:#fff;font-weight:700>if</span> ((httpContextAccessor.HttpContext.Request.Method == HttpMethods.Post ||
</span></span><span style=display:flex><span>                 httpContextAccessor.HttpContext.Request.Method == HttpMethods.Put) &amp;&amp;
</span></span><span style=display:flex><span>                 httpContextAccessor.HttpContext.Request.Body.CanRead)
</span></span><span style=display:flex><span>            {
</span></span><span style=display:flex><span>                <span style=color:#fff;font-weight:700>const</span> <span style=color:#fff;font-weight:700>string</span> jsonBody = <span style=color:#0ff;font-weight:700>&#34;JsonBody&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                <span style=color:#fff;font-weight:700>if</span> (requestTelemetry.Properties.ContainsKey(jsonBody))
</span></span><span style=display:flex><span>                {
</span></span><span style=display:flex><span>                    <span style=color:#fff;font-weight:700>return</span>;
</span></span><span style=display:flex><span>                }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                <span style=color:#007f7f>// Allows re-usage of the stream</span>
</span></span><span style=display:flex><span>                httpContextAccessor.HttpContext.Request.EnableRewind(); <span style=color:#007f7f>// .EnableBuffering() in ASP.NET Core 3</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                <span style=color:#fff;font-weight:700>var</span> stream = <span style=color:#fff;font-weight:700>new</span> StreamReader(httpContextAccessor.HttpContext.Request.Body);
</span></span><span style=display:flex><span>                <span style=color:#fff;font-weight:700>var</span> body = stream.ReadToEnd();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                <span style=color:#007f7f>// Reset the stream so data is not lost</span>
</span></span><span style=display:flex><span>                httpContextAccessor.HttpContext.Request.Body.Position = <span style=color:#ff0;font-weight:700>0</span>;
</span></span><span style=display:flex><span>                requestTelemetry.Properties.Add(jsonBody, body);
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p><a href=https://stackoverflow.com/a/50024016 class=external-link target=_blank rel=noopener>(Source Stack Overflow answer)</a></p><p>In ASP.NET Core 1.x and 2.x, this would add a new property named <em>JsonBody</em> to the telemetry, populated with the associated request&rsquo;s body content. The telemetry would be uploaded to Application Insights, visible on the request and associated with additional server-side processing, such as database requests.</p><p>After upgrading to ASP.NET Core 3 and switching to <code>EnableBuffering()</code>, the next exception is a bit concerning: <em><strong>System.InvalidOperationException</strong>: &lsquo;Synchronous operations are disallowed. Call ReadAsync or set AllowSynchronousIO to true instead.&rsquo;</em> One of the bigger breaking changes in ASP.NET Core 3.0 was <a href=https://docs.microsoft.com/en-us/dotnet/core/compatibility/2.2-3.0#http-synchronous-io-disabled-in-all-servers class=external-link target=_blank rel=noopener>disabling synchronous server IO by default</a>. While Microsoft provides a mitigation, I&rsquo;ve still run into issues with disposed objects afterward. It&rsquo;s time for a different approach.</p><h2 id=writing-custom-aspnet-core-custom-middleware>Writing custom ASP.NET Core custom middleware
<a class=heading-link href=#writing-custom-aspnet-core-custom-middleware><i class="fa-solid fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h2><p>Instead of continuing to fight exceptions, I decided to write custom middleware to snag the request body. <a href="https://docs.microsoft.com/en-us/aspnet/core/fundamentals/middleware/?view=aspnetcore-3.1" class=external-link target=_blank rel=noopener><em>Middleware</em></a> is all of the code that runs between the server receiving a request and returning a response. We mainly just add a few lines to our <code>Startup</code> class (like <code>app.UseAuthentication()</code>) and utilize built-in middleware from ASP.NET Core. However, we can easily <a href="https://docs.microsoft.com/en-us/aspnet/core/fundamentals/middleware/write?view=aspnetcore-3.1" class=external-link target=_blank rel=noopener>write our own middleware code</a> to be run for every request and response.</p><p>When writing a class for custom middleware, there&rsquo;s no <em>required*</em> interface or abstract class to implement. Instead, the class must:</p><ul><li>Have a public constructor that accepts a <a href=https://docs.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.http.requestdelegate class=external-link target=_blank rel=noopener><code>RequestDelegate</code></a>.<ul><li>The <code>RequestDelegate</code> is the next piece of middleware to be executed after yours.</li></ul></li><li>Implement a public method named either <code>Invoke</code> or <code>InvokeAsync</code>.<ul><li>It must return a <code>Task</code>, no matter the name.</li><li>It&rsquo;s first parameter must be <code>HttpContext</code>.</li><li>Any additional parameters will be populated by your dependency injection container.</li></ul></li></ul><p><em>*Note: ASP.NET Core 2.1 added an <a href="https://docs.microsoft.com/en-us/aspnet/core/fundamentals/middleware/extensibility?view=aspnetcore-3.1" class=external-link target=_blank rel=noopener><code>IMiddleware</code> interface</a> that can be implemented.</em></p><p>The pattern to implement is straightforward:</p><div class=highlight><pre tabindex=0 style=color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cs data-lang=cs><span style=display:flex><span><span style=color:#fff;font-weight:700>public</span> <span style=color:#fff;font-weight:700>async</span> Task InvokeAsync(HttpContext context, RequestDelegate next)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#007f7f>// Incoming request</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#fff;font-weight:700>await</span> next(context);    <span style=color:#007f7f>// Call the next middleware</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#007f7f>// Outgoing response</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>The method begins with a client HTTP request. If the middleware sets up anything necessary for the rest of the pipeline (authentication, authorization), it would be implemented at the beginning. Afterward, the method calls <code>await next(context)</code> to continue processing the request, potentially making it&rsquo;s way to a controller. Control returns as the stack is rewinding and a response is on the way back to the client.</p><p>Knowing this, we can write our own middleware to capture the request body before it&rsquo;s read downstream:</p><div class=highlight><div style=color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">56
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">57
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">58
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">59
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">60
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">61
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">62
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">63
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">64
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">65
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">66
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">67
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">68
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">69
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">70
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">71
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">72
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">73
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">74
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">75
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">76
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">77
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#727272">78
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cs data-lang=cs><span style=display:flex><span><span style=color:#fff;font-weight:700>public</span> <span style=color:#fff;font-weight:700>class</span> ApplicationInsightsLoggingMiddleware : IMiddleware
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#fff;font-weight:700>private</span> TelemetryClient TelemetryClient { <span style=color:#fff;font-weight:700>get</span>; }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#fff;font-weight:700>public</span> ApplicationInsightsLoggingMiddleware(TelemetryClient telemetryClient)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        TelemetryClient = telemetryClient;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#fff;font-weight:700>public</span> <span style=color:#fff;font-weight:700>async</span> Task InvokeAsync(HttpContext context, RequestDelegate next)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#007f7f>// Inbound (before the controller)</span>
</span></span><span style=display:flex><span>        <span style=color:#fff;font-weight:700>var</span> request = context?.Request;
</span></span><span style=display:flex><span>        <span style=color:#fff;font-weight:700>if</span> (request == <span style=color:#fff;font-weight:700>null</span>)
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            <span style=color:#fff;font-weight:700>await</span> next(context);
</span></span><span style=display:flex><span>            <span style=color:#fff;font-weight:700>return</span>;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        request.EnableBuffering();  <span style=color:#007f7f>// Allows us to reuse the existing Request.Body</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#007f7f>// Swap the original Response.Body stream with one we can read / seek</span>
</span></span><span style=display:flex><span>        <span style=color:#fff;font-weight:700>var</span> originalResponseBody = context.Response.Body;
</span></span><span style=display:flex><span>        <span style=color:#fff;font-weight:700>using</span> var replacementResponseBody = <span style=color:#fff;font-weight:700>new</span> MemoryStream();
</span></span><span style=display:flex><span>        context.Response.Body = replacementResponseBody;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#fff;font-weight:700>await</span> next(context); <span style=color:#007f7f>// Continue processing (additional middleware, controller, etc.)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#007f7f>// Outbound (after the controller)</span>
</span></span><span style=display:flex><span>        replacementResponseBody.Position = <span style=color:#ff0;font-weight:700>0</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#007f7f>// Copy the response body to the original stream</span>
</span></span><span style=display:flex><span>        <span style=color:#fff;font-weight:700>await</span> replacementResponseBody.CopyToAsync(originalResponseBody).ConfigureAwait(<span style=color:#fff;font-weight:700>false</span>);
</span></span><span style=display:flex><span>        context.Response.Body = originalResponseBody;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#fff;font-weight:700>var</span> response = context.Response;
</span></span><span style=display:flex><span>        <span style=color:#fff;font-weight:700>if</span> (response.StatusCode &lt; <span style=color:#ff0;font-weight:700>500</span>)
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            <span style=color:#fff;font-weight:700>return</span>;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#fff;font-weight:700>var</span> requestTelemetry = context.Features.Get&lt;RequestTelemetry&gt;();
</span></span><span style=display:flex><span>        <span style=color:#fff;font-weight:700>if</span> (requestTelemetry == <span style=color:#fff;font-weight:700>null</span>)
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            <span style=color:#fff;font-weight:700>return</span>;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#fff;font-weight:700>if</span> (request.Body.CanRead)
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            <span style=color:#fff;font-weight:700>var</span> requestBodyString = <span style=color:#fff;font-weight:700>await</span> ReadBodyStream(request.Body).ConfigureAwait(<span style=color:#fff;font-weight:700>false</span>);
</span></span><span style=display:flex><span>            requestTelemetry.Properties.Add(<span style=color:#0ff;font-weight:700>&#34;RequestBody&#34;</span>, requestBodyString);  <span style=color:#007f7f>// limit: 8192 characters</span>
</span></span><span style=display:flex><span>            TelemetryClient.TrackTrace(requestBodyString);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#fff;font-weight:700>if</span> (replacementResponseBody.CanRead)
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            <span style=color:#fff;font-weight:700>var</span> responseBodyString = <span style=color:#fff;font-weight:700>await</span> ReadBodyStream(replacementResponseBody).ConfigureAwait(<span style=color:#fff;font-weight:700>false</span>);
</span></span><span style=display:flex><span>            requestTelemetry.Properties.Add(<span style=color:#0ff;font-weight:700>&#34;ResponseBody&#34;</span>, responseBodyString);
</span></span><span style=display:flex><span>            TelemetryClient.TrackTrace(responseBodyString);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#fff;font-weight:700>private</span> <span style=color:#fff;font-weight:700>async</span> Task&lt;<span style=color:#fff;font-weight:700>string</span>&gt; ReadBodyStream(Stream body)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#fff;font-weight:700>if</span> (body.Length == <span style=color:#ff0;font-weight:700>0</span>)
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            <span style=color:#fff;font-weight:700>return</span> <span style=color:#fff;font-weight:700>null</span>;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        body.Position = <span style=color:#ff0;font-weight:700>0</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#fff;font-weight:700>using</span> var reader = <span style=color:#fff;font-weight:700>new</span> StreamReader(body, leaveOpen: <span style=color:#fff;font-weight:700>true</span>);
</span></span><span style=display:flex><span>        <span style=color:#fff;font-weight:700>var</span> bodyString = <span style=color:#fff;font-weight:700>await</span> reader.ReadToEndAsync().ConfigureAwait(<span style=color:#fff;font-weight:700>false</span>);
</span></span><span style=display:flex><span>        body.Position = <span style=color:#ff0;font-weight:700>0</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#fff;font-weight:700>return</span> bodyString;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>This version goes beyond the original <em>ITelemetryInitializer</em> implementation, logging both the request and response bodies if a server error occurred. It also uses the <code>TrackTrace</code> method, allowing for four times the data to be sent to Application Insights. <strong>An important note</strong>: this doesn&rsquo;t discrimate based on endpoint or request/response body content; be careful of logging sensitive data in a production environment.</p><p>Finally, two changes are made in the <em>Startup</em> class in order to run the middleware.</p><p>First, register the middleware with the dependency injection container in the <code>ConfigureServices</code> method:</p><div class=highlight><pre tabindex=0 style=color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cs data-lang=cs><span style=display:flex><span><span style=color:#fff;font-weight:700>public</span> <span style=color:#fff;font-weight:700>void</span> ConfigureServices(IServiceCollection services)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    ...
</span></span><span style=display:flex><span>    services.AddTransient&lt;ApplicationInsightsLoggingMiddleware&gt;(); 
</span></span><span style=display:flex><span>    ...
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Second, register the middleware in the request processing pipeline:</p><div class=highlight><pre tabindex=0 style=color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cs data-lang=cs><span style=display:flex><span><span style=color:#fff;font-weight:700>public</span> <span style=color:#fff;font-weight:700>void</span> Configure(IApplicationBuilder app, IWebHostEnvironment env)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#fff;font-weight:700>if</span> (env.IsDevelopment())
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        app.UseDeveloperExceptionPage();
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#fff;font-weight:700>else</span>
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        app.UseExceptionHandler(<span style=color:#0ff;font-weight:700>&#34;/Error&#34;</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    app.UseHttpsRedirection();
</span></span><span style=display:flex><span>    app.UseStaticFiles();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    app.UseRouting();
</span></span><span style=display:flex><span>    app.UseCors();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    app.UseAuthentication();
</span></span><span style=display:flex><span>    app.UseAuthorization();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#007f7f>// Placement matters!</span>
</span></span><span style=display:flex><span>    <span style=color:#007f7f>// Place custom middleware after security...</span>
</span></span><span style=display:flex><span>    app.UseMiddleware&lt;ApplicationInsightsLoggingMiddleware&gt;();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#007f7f>// ...but before specifying endpoints  </span>
</span></span><span style=display:flex><span>    app.UseEndpoints(endpoints =&gt;
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        endpoints.MapRazorPages();
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Middleware will execute in the <a href="https://docs.microsoft.com/en-us/aspnet/core/fundamentals/middleware/?view=aspnetcore-3.1#middleware-order" class=external-link target=_blank rel=noopener>order of registration</a>. It&rsquo;s important to register security middleware correctly. The <code>ApplicationInsightsLoggingMiddleware</code> will only execute after successful processing of the built-in CORS, authentication, and authorization middleware.</p></div><footer></footer></article></section></div><footer class=footer><section class=container>©
2020 -
2025
Tim Jarzombek
·
Powered by <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a> & <a href=https://github.com/luizdepra/hugo-coder/ target=_blank rel=noopener>Coder</a>.</section></footer></main><script src=https://jarz.net/js/coder.min.6ae284be93d2d19dad1f02b0039508d9aab3180a12a06dcc71b0b0ef7825a317.js integrity="sha256-auKEvpPS0Z2tHwKwA5UI2aqzGAoSoG3McbCw73gloxc="></script></body></html>